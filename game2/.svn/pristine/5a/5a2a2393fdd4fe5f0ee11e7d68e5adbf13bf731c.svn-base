package model

import (
	"fmt"
	"strconv"
	"time"
)

type Advertisement struct {
	Type     int    `json:"type,omitempty"`
	Location int    `json:"location"`
	Sort     int    `json:"srot"`
	Name     string `json:"name"`
	Image    string `json:"image"`
	Url      string `json:"url"`
}

func (ad Advertisement) GetAdvertisementList(merchant_id int) []Advertisement {
	fmt.Println(merchant_id)
	var adslist []Advertisement
	var params []interface{}
	now := time.Now().Unix()
	now_str := strconv.FormatInt(now, 10)
	params = append(params, merchant_id)
	sql := "SELECT type,location,sort,name,image,url FROM merchant_ads Where merchant_id=?"
	if ad.Type != 0 {
		sql = sql + " AND type=?"
		params = append(params, ad.Type)
	}
	if ad.Location != 0 {
		sql = sql + " AND location=?"
		params = append(params, ad.Location)
	}
	sql = sql + " AND status=1 AND start_time<=" + now_str + " AND end_time >=" + now_str
	fmt.Println(sql)
	stmt, err := Db.Prepare(sql)
	defer stmt.Close()
	if err != nil {
		fmt.Println(err)
		return adslist
	}
	rows, err := stmt.Query(params...)
	defer rows.Close()
	if err != nil {
		fmt.Println(err)
		return adslist
	}
	for rows.Next() {
		var conv Advertisement
		rows.Scan(&conv.Type, &conv.Location, &conv.Sort, &conv.Name, &conv.Image, &conv.Url)
		adslist = append(adslist, conv)
	}
	return adslist
}
